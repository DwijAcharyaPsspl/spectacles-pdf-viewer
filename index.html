// PDFViewerController.js - Enhanced Version for Spectacles with Hand Gestures

// @input SceneObject webViewObject {"hint":"Assign your PDF_Viewer_Screen object"}
// @input SceneObject handTrackingObject {"hint":"Assign HandTracking object or Camera"}
// @input bool debugMode = true
// @input float clickThreshold = 0.1 {"hint":"Distance threshold for click detection"}
// @input float swipeThreshold = 0.3 {"hint":"Distance threshold for swipe detection"}

var webView = null;
var handTracking = null;
var isInitialized = false;
var isPDFOpen = false;

// Hand gesture tracking variables
var lastHandPosition = null;
var isTracking = false;
var gestureStartPosition = null;
var gestureStartTime = 0;
var lastGestureTime = 0;
var minGestureInterval = 1000; // 1 second between gestures

// PDF state
var currentPage = 1;
var totalPages = 1;

function initialize() {
    print("=== Enhanced PDF Viewer Starting ===");
    
    if (!script.webViewObject) {
        print("ERROR: Web View Object not assigned!");
        return;
    }
    
    // Setup hand tracking
    setupHandTracking();
    
    // Initialize WebView with delay
    var initDelay = script.createEvent("DelayedCallbackEvent");
    initDelay.bind(function() {
        findAndSetupWebView();
    });
    initDelay.reset(2.0);
}

function setupHandTracking() {
    print("Setting up hand tracking...");
    
    // Try to find hand tracking component
    if (script.handTrackingObject) {
        var handTrackingComponents = script.handTrackingObject.getComponents("Component.HandTracking");
        if (handTrackingComponents.length > 0) {
            handTracking = handTrackingComponents[0];
            print("Found HandTracking component");
        } else {
            print("HandTracking component not found, creating update event for manual tracking");
        }
    }
    
    // Setup update event for hand tracking
    var updateEvent = script.createEvent("UpdateEvent");
    updateEvent.bind(onUpdate);
}

function findAndSetupWebView() {
    print("Looking for WebView component...");
    
    var scripts = script.webViewObject.getComponents("Component.ScriptComponent");
    
    for (var i = 0; i < scripts.length; i++) {
        var component = scripts[i];
        if (component === script) continue;
        
        webView = component;
        print("Found WebView component!");
        break;
    }
    
    if (!webView) {
        print("ERROR: No WebView component found");
        return;
    }
    
    checkWebViewReady();
}

function checkWebViewReady() {
    var checkCount = 0;
    var readyCheck = script.createEvent("UpdateEvent");
    
    readyCheck.bind(function() {
        checkCount++;
        
        if (checkCount > 150 || isInitialized) { // 5 seconds at 30fps
            readyCheck.enabled = false;
            
            if (!isInitialized) {
                isInitialized = true;
                print("WebView ready - setting up PDF");
                setupPDF();
            }
        }
    });
}

function setupPDF() {
    print("Setting up PDF viewer...");
    
    if (webView && webView.executeJavaScript) {
        // Initialize the PDF viewer in closed state
        executeJS("document.body.style.display = 'none';");
        
        // Setup PDF viewer after page loads
        var pdfSetup = script.createEvent("DelayedCallbackEvent");
        pdfSetup.bind(function() {
            executeJS(`
                // Wait for PDF to be fully loaded
                var checkReady = setInterval(function() {
                    if (window.spectaclesPDF && window.spectaclesPDF.isInitialized && window.spectaclesPDF.isInitialized()) {
                        clearInterval(checkReady);
                        console.log('PDF viewer ready for Spectacles');
                        
                        // Setup page info callback
                        window.updatePageInfo = function(current, total) {
                            console.log('Page info updated:', current, '/', total);
                        };
                    }
                }, 100);
                
                // Timeout after 10 seconds
                setTimeout(function() {
                    if (checkReady) clearInterval(checkReady);
                }, 10000);
            `);
            
            // Show thumbnail after setup
            var showThumbDelay = script.createEvent("DelayedCallbackEvent");
            showThumbDelay.bind(function() {
                showPDFThumbnail();
            });
            showThumbDelay.reset(2.0);
        });
        pdfSetup.reset(3.0);
    }
}

function showPDFThumbnail() {
    print("Showing PDF thumbnail");
    isPDFOpen = false;
    
    executeJS(`
        if (window.spectaclesPDF && window.spectaclesPDF.showThumbnail) {
            window.spectaclesPDF.showThumbnail();
        }
    `);
}

function openPDFFullView() {
    print("Opening PDF full view");
    isPDFOpen = true;
    
    executeJS(`
        if (window.spectaclesPDF && window.spectaclesPDF.openFullView) {
            window.spectaclesPDF.openFullView();
        }
        setTimeout(function() {
            if (window.spectaclesPDF && window.spectaclesPDF.fitToScreen) {
                window.spectaclesPDF.fitToScreen();
            }
        }, 500);
    `);
}

function closePDFView() {
    print("Closing PDF view");
    showPDFThumbnail();
}

function nextPage() {
    if (!isPDFOpen) return;
    
    print("Next page");
    executeJS(`
        if (window.spectaclesPDF) {
            window.spectaclesPDF.nextPage();
        }
    `);
}

function previousPage() {
    if (!isPDFOpen) return;
    
    print("Previous page");
    executeJS(`
        if (window.spectaclesPDF) {
            window.spectaclesPDF.previousPage();
        }
    `);
}

function onUpdate() {
    if (!isInitialized) return;
    
    // Get current time
    var currentTime = getTime() * 1000; // Convert to milliseconds
    
    // Prevent too frequent gestures
    if (currentTime - lastGestureTime < minGestureInterval) {
        return;
    }
    
    // Try to get hand position
    var handPosition = getHandPosition();
    
    if (handPosition) {
        if (!isTracking) {
            // Start tracking
            isTracking = true;
            gestureStartPosition = handPosition;
            gestureStartTime = currentTime;
            lastHandPosition = handPosition;
            return;
        }
        
        // Check for gestures
        var deltaTime = currentTime - gestureStartTime;
        var deltaPosition = vec3.distance(handPosition, gestureStartPosition);
        
        // Click gesture (minimal movement, short duration)
        if (deltaTime > 200 && deltaTime < 800 && deltaPosition < script.clickThreshold) {
            onHandClick(handPosition);
            resetGestureTracking();
            lastGestureTime = currentTime;
            return;
        }
        
        // Swipe gesture (significant movement)
        if (deltaPosition > script.swipeThreshold && deltaTime > 300) {
            var swipeDirection = getSwipeDirection(gestureStartPosition, handPosition);
            onHandSwipe(swipeDirection);
            resetGestureTracking();
            lastGestureTime = currentTime;
            return;
        }
        
        // Update last position
        lastHandPosition = handPosition;
        
        // Reset if gesture takes too long
        if (deltaTime > 2000) {
            resetGestureTracking();
        }
    } else {
        // No hand detected
        if (isTracking) {
            resetGestureTracking();
        }
    }
}

function getHandPosition() {
    // Try multiple methods to get hand position
    
    // Method 1: HandTracking component
    if (handTracking) {
        try {
            var rightHand = handTracking.getRightHand();
            if (rightHand && rightHand.isTracked()) {
                var indexTip = rightHand.getIndexTip();
                if (indexTip) {
                    return indexTip.getPosition();
                }
            }
            
            var leftHand = handTracking.getLeftHand();
            if (leftHand && leftHand.isTracked()) {
                var indexTip = leftHand.getIndexTip();
                if (indexTip) {
                    return indexTip.getPosition();
                }
            }
        } catch (error) {
            // Silent fail, try next method
        }
    }
    
    // Method 2: Try to find HandTracking in scene
    try {
        var handTrackingObjects = global.scene.findObjectsByName("HandTracking");
        if (handTrackingObjects.length > 0) {
            var ht = handTrackingObjects[0].getComponent("Component.HandTracking");
            if (ht) {
                var rightHand = ht.getRightHand();
                if (rightHand && rightHand.isTracked()) {
                    var indexTip = rightHand.getIndexTip();
                    if (indexTip) {
                        return indexTip.getPosition();
                    }
                }
            }
        }
    } catch (error) {
        // Silent fail
    }
    
    return null;
}

function getSwipeDirection(startPos, endPos) {
    var delta = vec3.subtract(endPos, startPos);
    
    // Determine primary direction
    if (Math.abs(delta.x) > Math.abs(delta.y) && Math.abs(delta.x) > Math.abs(delta.z)) {
        return delta.x > 0 ? "right" : "left";
    } else if (Math.abs(delta.y) > Math.abs(delta.z)) {
        return delta.y > 0 ? "up" : "down";
    } else {
        return delta.z > 0 ? "forward" : "backward";
    }
}

function onHandClick(position) {
    if (script.debugMode) {
        print("Hand click detected at: " + position.toString());
    }
    
    if (!isPDFOpen) {
        openPDFFullView();
    } else {
        closePDFView();
    }
}

function onHandSwipe(direction) {
    if (script.debugMode) {
        print("Hand swipe detected: " + direction);
    }
    
    if (!isPDFOpen) return;
    
    switch (direction) {
        case "left":
            nextPage();
            break;
        case "right":
            previousPage();
            break;
        case "up":
            closePDFView();
            break;
    }
}

function resetGestureTracking() {
    isTracking = false;
    gestureStartPosition = null;
    gestureStartTime = 0;
    lastHandPosition = null;
}

function executeJS(code) {
    if (!webView) return;
    
    try {
        if (webView.executeJavaScript) {
            webView.executeJavaScript(code);
        }
        if (script.debugMode && code.length < 100) {
            print("JS: " + code);
        }
    } catch (error) {
        if (script.debugMode) {
            print("JS Error: " + error);
        }
    }
}

// Utility function to get current time
function getTime() {
    return script.getSceneObject().getTransform().getWorldPosition().x * 0 + global.getTime();
}

// Initialize when script starts
script.createEvent("OnStartEvent").bind(initialize);

// Cleanup on disable
script.createEvent("OnDestroyEvent").bind(function() {
    print("PDF Viewer Controller destroyed");
});

print("Enhanced PDF Viewer Controller loaded");
